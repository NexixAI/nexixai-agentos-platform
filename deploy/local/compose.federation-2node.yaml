name: agentos-federation-2node

# This compose file runs TWO AgentOS nodes on one host for Phase 8 federation testing.
# It intentionally uses the official golang image + bind-mounts the repo so you do NOT need a Dockerfile.
#
# Node A: agent-orchestrator 8081, model-policy 8082, federation 8083 (internal-only)
# Node B: agent-orchestrator 8084, model-policy 8085, federation 8086 (internal-only)

services:
  nodea-agent-orchestrator:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      # docker compose resolves relative paths from the *project directory* (usually the repo root)
      # not from this file's directory. Using '.' keeps CI + local consistent.
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8081","agent-orchestrator"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=agent-orchestrator
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_RUN_CREATE_QPS=10
      - AGENTOS_QUOTA_CONCURRENT_RUNS=25
      - AGENTOS_RUN_STORE_FILE=/workspace/data/nodea/agent-orchestrator/runs.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodea/agent-orchestrator/audit.log

  nodea-model-policy:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8082","model-policy"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=model-policy
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_INVOKE_QPS=20
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodea/model-policy/audit.log

  nodea-federation:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8083","federation"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=federation
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_FED_FORWARD_INDEX_FILE=/workspace/data/nodea/federation/forward-index.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodea/federation/audit.log
      - AGENTOS_STACK_ID=stk_local_node_a
      - AGENTOS_ENVIRONMENT=local
      - AGENTOS_REGION=local
      - AGENTOS_PEERS_FILE=/workspace/deploy/local/peers.seed.json

  nodeb-agent-orchestrator:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8084","agent-orchestrator"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=agent-orchestrator
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_RUN_CREATE_QPS=10
      - AGENTOS_QUOTA_CONCURRENT_RUNS=25
      - AGENTOS_RUN_STORE_FILE=/workspace/data/nodeb/agent-orchestrator/runs.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodeb/agent-orchestrator/audit.log

  nodeb-model-policy:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8085","model-policy"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=model-policy
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_INVOKE_QPS=20
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodeb/model-policy/audit.log

  nodeb-federation:
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ../..:/workspace
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    command: ["go","run","./cmd/agentos","serve","--addr",":8086","federation"]
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=federation
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_FED_FORWARD_INDEX_FILE=/workspace/data/nodeb/federation/forward-index.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/nodeb/federation/audit.log
      - AGENTOS_STACK_ID=stk_local_node_b
      - AGENTOS_ENVIRONMENT=local
      - AGENTOS_REGION=local
      - AGENTOS_PEERS_FILE=/workspace/deploy/local/peers.seed.json

volumes:
  go-mod-cache:
  go-build-cache:
