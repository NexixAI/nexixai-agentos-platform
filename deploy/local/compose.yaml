name: agentos-local

services:
  agent-orchestrator:
    build:
      context: ../..
    command: ["serve","--addr",":8081","agent-orchestrator"]
    ports:
      - "50081:8081"
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=agent-orchestrator
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_RUN_CREATE_QPS=10
      - AGENTOS_QUOTA_CONCURRENT_RUNS=25
      - AGENTOS_RUN_STORE_FILE=/workspace/data/agent-orchestrator/runs.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/agent-orchestrator/audit.log

  model-policy:
    build:
      context: ../..
    command: ["serve","--addr",":8082","model-policy"]
    ports:
      - "50082:8082"
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=model-policy
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_QUOTA_INVOKE_QPS=20
      - AGENTOS_AUDIT_SINK=file:/workspace/data/model-policy/audit.log

  federation:
    build:
      context: ../..
    command: ["serve","--addr",":8083","federation"]
    ports:
      - "50083:8083"
    env_file:
      - ./secrets.example.env
    environment:
      - AGENTOS_SERVICE=federation
      - AGENTOS_DEFAULT_TENANT=tnt_demo
      - AGENTOS_FED_FORWARD_INDEX_FILE=/workspace/data/federation/forward-index.json
      - AGENTOS_AUDIT_SINK=file:/workspace/data/federation/audit.log

  worker-node-a:
    image: busybox:1.36
    command: ["sleep","infinity"]
    profiles: ["workers"]
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - WORKER_ROLE=executor
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    volumes:
      - worker-a-artifacts:/workspace/artifacts

  worker-node-b:
    image: busybox:1.36
    command: ["sleep","infinity"]
    profiles: ["workers"]
    environment:
      - CUDA_VISIBLE_DEVICES=1
      - WORKER_ROLE=executor
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    volumes:
      - worker-b-artifacts:/workspace/artifacts

volumes:
  worker-a-artifacts: {}
  worker-b-artifacts: {}
