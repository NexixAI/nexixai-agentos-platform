name: Federation E2E

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  federation-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install federation e2e deps
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/federation_e2e/requirements.txt

      - name: Start 2-node federation stack
        run: |
          docker compose -f deploy/local/compose.federation-2node.yaml up -d
          docker compose -f deploy/local/compose.federation-2node.yaml ps

      - name: Wait for health
        run: |
          set -euo pipefail

          # Services are compiled + started via `go run` inside the containers,
          # so first boot can take longer than typical HTTP health waits.
          endpoints=(
            "http://localhost:8081/v1/health"  # nodea stack-a
            "http://localhost:8082/v1/health"  # nodea stack-b
            "http://localhost:8083/v1/federation/health"  # nodea federation
            "http://localhost:8084/v1/health"  # nodeb stack-a
            "http://localhost:8085/v1/health"  # nodeb stack-b
            "http://localhost:8086/v1/federation/health"  # nodeb federation
          )

          ok=0
          for i in $(seq 1 120); do
            ok=0
            for url in "${endpoints[@]}"; do
              if curl -fsS "$url" >/dev/null; then
                ok=$((ok+1))
              fi
            done
            echo "Health: $ok/${#endpoints[@]} endpoints ready (attempt $i/120)"
            if [ "$ok" -eq "${#endpoints[@]}" ]; then
              echo "All services healthy"
              exit 0
            fi
            sleep 2
          done

          echo "Services did not become healthy in time. Dumping docker compose status/logs..."
          docker compose -f deploy/local/compose.federation-2node.yaml ps || true
          docker compose -f deploy/local/compose.federation-2node.yaml logs --no-color | tail -n 400 || true
          exit 1

      - name: Run federation e2e
        run: |
          python tests/federation_e2e/run_federation_e2e.py

      - name: Dump logs on failure
        if: failure()
        run: |
          docker compose -f deploy/local/compose.federation-2node.yaml logs --no-color | tail -n 400

      - name: Shutdown
        if: always()
        run: |
          docker compose -f deploy/local/compose.federation-2node.yaml down -v
