openapi: 3.0.3
info:
  title: NexixAI AgentOS â€” Stack A (Orchestration) API
  version: "1.0.2"
  description: |
    Stack A (Orchestration) is the product-facing control plane for AgentOS:
    - Create Runs
    - Fetch Run state
    - Stream Run events (SSE)

    Payload truth is defined in:
    - docs/product/agentos-prs/v1.02-schemas-appendix.md

servers:
  - url: /

tags:
  - name: Health
  - name: Runs
  - name: Events

security:
  - bearerAuth: []
  - apiKeyAuth: []

paths:
  /v1/health:
    get:
      tags: [Health]
      summary: Health check
      operationId: stackAHealth
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              examples:
                ok:
                  value:
                    status: ok
                    service: stack-a
                    version: "1.0.2"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  /v1/agents/{agent_id}/runs:
    post:
      tags: [Runs]
      summary: Create a run for an agent
      description: |
        Creates a new run for the specified agent.

        Idempotency:
        - Provide `idempotency_key` in the request body to make this operation idempotent.
        - Replays return the existing run for the same tenant/principal/agent + key.

        Tenant:
        - `tenant_id` is derived from auth (JWT/service token).
        - An optional `X-Tenant-Id` header may be used for service-to-service calls (policy choice),
          but internal `auth.tenant_id` remains authoritative.
      operationId: createRun
      parameters:
        - $ref: "#/components/parameters/AgentId"
        - $ref: "#/components/parameters/XTenantId"
        - $ref: "#/components/parameters/XCorrelationId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunCreateRequest"
      responses:
        "201":
          description: Created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunCreateResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  /v1/runs/{run_id}:
    get:
      tags: [Runs]
      summary: Get run
      description: Fetches the current state of a run.
      operationId: getRun
      parameters:
        - $ref: "#/components/parameters/RunId"
        - $ref: "#/components/parameters/XTenantId"
        - $ref: "#/components/parameters/XCorrelationId"
      responses:
        "200":
          description: OK
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunGetResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  /v1/runs/{run_id}/events:
    get:
      tags: [Events]
      summary: Stream run events (SSE)
      description: |
        Streams run events as Server-Sent Events.

        Response is `text/event-stream` with the event envelope serialized as JSON in the SSE `data:` field.

        Semantics:
        - Delivery: at-least-once
        - Ordering: by `event.sequence` per run
        - Dedupe: by `event.event_id`
      operationId: streamRunEvents
      parameters:
        - $ref: "#/components/parameters/RunId"
        - $ref: "#/components/parameters/XTenantId"
        - $ref: "#/components/parameters/XCorrelationId"
        - name: after_sequence
          in: query
          required: false
          description: Start streaming after this sequence number (exclusive).
          schema:
            type: integer
            minimum: 0
      responses:
        "200":
          description: SSE stream
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            text/event-stream:
              schema:
                type: string
              examples:
                eventEnvelope:
                  summary: Example SSE event (data is JSON)
                  value: |
                    event: agentos.event
                    data: {"event":{"event_id":"evt_01J...","sequence":12,"time":"2025-12-19T22:15:36Z","type":"agentos.run.step.started","tenant_id":"tnt_demo","agent_id":"agt_...","run_id":"run_...","step_id":"stp_...","trace":{"traceparent":"00-...-...-01","span_id":"..."},"payload":{"name":"plan","message":"Planning next actions"}}}

        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Primary auth mechanism. Tenant context is derived from token claims.
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Optional API key for service-to-service integrations.

  headers:
    XRequestId:
      description: Request id assigned by the service (or propagated).
      schema:
        type: string

  parameters:
    AgentId:
      name: agent_id
      in: path
      required: true
      schema: { type: string }
      description: Agent identifier.

    RunId:
      name: run_id
      in: path
      required: true
      schema: { type: string }
      description: Run identifier.

    XTenantId:
      name: X-Tenant-Id
      in: header
      required: false
      schema: { type: string }
      description: |
        Optional explicit tenant header for service-to-service calls (policy choice).
        Tenant derived from auth remains authoritative.

    XCorrelationId:
      name: X-Correlation-Id
      in: header
      required: false
      schema: { type: string }
      description: Correlation id for end-to-end tracing/logging.

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    NotFound:
      description: Not found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Conflict:
      description: Conflict
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    RateLimited:
      description: Rate limited
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    ServiceUnavailable:
      description: Service unavailable
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }

  schemas:
    HealthResponse:
      type: object
      required: [status, service, version]
      properties:
        status: { type: string, enum: [ok] }
        service: { type: string, enum: [stack-a] }
        version: { type: string }

    # Error model (matches Schemas Appendix)
    ErrorResponse:
      type: object
      required: [error, correlation_id]
      properties:
        error:
          $ref: "#/components/schemas/ErrorObject"
        correlation_id:
          type: string

    ErrorObject:
      type: object
      required: [code, message, retryable, details]
      properties:
        code: { type: string }
        message: { type: string }
        retryable: { type: boolean }
        details:
          type: object
          additionalProperties: true

    RunStatus:
      type: string
      enum: [queued, running, completed, failed, canceled]

    Priority:
      type: string
      enum: [low, normal, high]

    RunInput:
      type: object
      required: [type]
      properties:
        type:
          type: string
          description: Input type.
          enum: [text]
        text:
          type: string
          nullable: true
          description: Present when input.type == "text".
      additionalProperties: false

    RunContext:
      type: object
      properties:
        locale: { type: string }
        timezone: { type: string }
        channel: { type: string }
        labels:
          type: object
          additionalProperties: { type: string }
      additionalProperties: true

    RunConstraints:
      type: object
      description: Constraints for the run (tools, policies, etc.).
      properties:
        tool_denymap:
          type: array
          items: { type: string }
      additionalProperties: true

    RunOptions:
      type: object
      properties:
        priority: { $ref: "#/components/schemas/Priority" }
        timeout_ms: { type: integer, minimum: 0 }
        max_steps: { type: integer, minimum: 0 }
        stream_events: { type: boolean }
        dry_run: { type: boolean }
      additionalProperties: true

    RunCreateRequest:
      type: object
      required: [input]
      properties:
        input:
          $ref: "#/components/schemas/RunInput"
        context:
          $ref: "#/components/schemas/RunContext"
        constraints:
          $ref: "#/components/schemas/RunConstraints"
        run_options:
          $ref: "#/components/schemas/RunOptions"
        idempotency_key:
          type: string
          description: Idempotency key for create-run.
      additionalProperties: false

    RunOutput:
      type: object
      properties:
        type: { type: string }
        text: { type: string, nullable: true }
      additionalProperties: true

    RunError:
      type: object
      required: [code, message, retryable]
      properties:
        code: { type: string }
        message: { type: string }
        retryable: { type: boolean }
        details:
          type: object
          additionalProperties: true
      additionalProperties: true

    Run:
      type: object
      required: [tenant_id, agent_id, run_id, status, created_at]
      properties:
        tenant_id: { type: string }
        agent_id: { type: string }
        run_id: { type: string }
        status: { $ref: "#/components/schemas/RunStatus" }
        created_at: { type: string, format: date-time }
        started_at: { type: string, format: date-time, nullable: true }
        completed_at: { type: string, format: date-time, nullable: true }
        events_url: { type: string }
        run_options: { $ref: "#/components/schemas/RunOptions" }
        summary:
          type: object
          additionalProperties: true
        output:
          oneOf:
            - $ref: "#/components/schemas/RunOutput"
            - type: "null"
        error:
          oneOf:
            - $ref: "#/components/schemas/RunError"
            - type: "null"
        correlation_id:
          type: string
          description: Correlation id associated with the run.
      additionalProperties: true

    RunCreateResponse:
      type: object
      required: [run, correlation_id]
      properties:
        run:
          $ref: "#/components/schemas/Run"
        correlation_id:
          type: string
      additionalProperties: false

    RunGetResponse:
      type: object
      required: [run]
      properties:
        run:
          $ref: "#/components/schemas/Run"
        correlation_id:
          type: string
      additionalProperties: false

    TraceContext:
      type: object
      properties:
        traceparent: { type: string }
        span_id: { type: string }
      additionalProperties: true

    Event:
      type: object
      required: [event_id, sequence, time, type, tenant_id, agent_id, run_id, payload]
      properties:
        event_id: { type: string }
        sequence: { type: integer, minimum: 0 }
        time: { type: string, format: date-time }
        type: { type: string }
        tenant_id: { type: string }
        agent_id: { type: string }
        run_id: { type: string }
        step_id: { type: string, nullable: true }
        trace: { $ref: "#/components/schemas/TraceContext" }
        payload:
          type: object
          additionalProperties: true
      additionalProperties: true

    EventEnvelope:
      type: object
      required: [event]
      properties:
        event:
          $ref: "#/components/schemas/Event"
      additionalProperties: false
